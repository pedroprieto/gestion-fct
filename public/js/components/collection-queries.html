<link rel='ractive' href='./input-dynamic.html' name='inputdynamic'>

<ul>
{{ #collection.queries }}
  <li class="{{ name }}">
    <div class="{{ title }}">
      {{ prompt  }}      
    </div>
    <form action="{{ href }}" class="{{ rel }}" method="get" on-submit="httpQuery">
      <fieldset>
	<legend>
	  {{ prompt }}
	</legend>
	{{ #data }}
	<div class="input-field {{name}}">
	  <label for="{{name}}" class="data">{{prompt}}</label>
	  <inputdynamic data='{{.}}'/>
	</div>
	{{ / }}
	<div class="submit-query">
	  <button type="submit" class="submit-query-button">Buscar</button>
	</div>
      </fieldset>      
    </form>
    
    
  </li>
{{  / }}

</ul>


<script>

// Only load if we are in browser
if (typeof window !== 'undefined') {
  require('fetch');
}

component.exports = {
  oninit: function() {
    this.on( 'httpQuery', function ( event ) {
      var query = event.context.href + "/?";
      var q = 0;
      for (var i in event.context.data) {
	var o = event.context.data[i];
	if (o.name && o.name!=='') {
	  if(q++!==0) {
	    query += "&";
	  }
	  query += o.name+"="+encodeURI(o.value);
	}
      }
      
      ins = this;

      // Ajax call and update collection
      fetch(query, {
	credentials: 'same-origin',
	headers: {
	  'Accept': 'application/vnd.collection+json'
	}
      })
	.then(function(response) {
	  return response.text()
	}).then(function(text) {
	  ins.set({'collection': JSON.parse(text).collection});
	}).catch(function(ex) {
	  console.log('parsing failed', ex)
	});

      return false;
	

    });
    
  }
};


</script>
